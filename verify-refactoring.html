<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>é‡æ„éªŒè¯æµ‹è¯•</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        .test-result {
            margin: 5px 0;
            padding: 8px;
            border-radius: 4px;
        }
        .pass { background: #1e7e34; }
        .fail { background: #c82333; }
        .warn { background: #e0a800; }
        .summary {
            margin-top: 20px;
            padding: 15px;
            background: #2d2d30;
            border-radius: 8px;
            font-size: 18px;
        }
        h1 { color: #4ec9b0; }
        h2 { color: #569cd6; }
        pre { 
            background: #2d2d30; 
            padding: 10px; 
            border-radius: 4px;
            overflow-x: auto;
        }
        .action-buttons {
            margin: 20px 0;
        }
        button {
            padding: 10px 20px;
            margin-right: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
    </style>
</head>
<body>
    <h1>ğŸ§ª Linuså¼é‡æ„éªŒè¯</h1>
    <p>éªŒè¯StorageManagerå’ŒStateManageræ˜¯å¦æ­£ç¡®é›†æˆ...</p>
    
    <div class="action-buttons">
        <button class="btn-primary" onclick="runTests()">â–¶ï¸ è¿è¡Œæµ‹è¯•</button>
        <button class="btn-success" onclick="createBackup()">ğŸ’¾ åˆ›å»ºå¤‡ä»½</button>
        <button class="btn-danger" onclick="clearConsole()">ğŸ—‘ï¸ æ¸…ç©ºæ§åˆ¶å°</button>
    </div>
    
    <div id="test-results"></div>
    <div id="summary" class="summary" style="display:none;"></div>
    
    <!-- å¼•å…¥æ ¸å¿ƒæ¨¡å— -->
    <script src="scripts/core/storage.js"></script>
    <script src="scripts/core/state-manager.js"></script>
    <script src="scripts/core/task-manager.js"></script>
    
    <script>
        const results = {
            passed: 0,
            failed: 0,
            warnings: 0,
            tests: []
        };
        
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            
            let icon = 'âœ…';
            if (type === 'fail') icon = 'âŒ';
            if (type === 'warn') icon = 'âš ï¸';
            
            div.textContent = `${icon} ${message}`;
            document.getElementById('test-results').appendChild(div);
        }
        
        function test(name, fn) {
            try {
                const result = fn();
                if (result === true) {
                    log(`${name}`, 'pass');
                    results.passed++;
                    results.tests.push({ name, status: 'pass' });
                } else if (result === 'warning') {
                    log(`${name}`, 'warn');
                    results.warnings++;
                    results.tests.push({ name, status: 'warn' });
                } else {
                    log(`${name}: ${result}`, 'fail');
                    results.failed++;
                    results.tests.push({ name, status: 'fail', error: result });
                }
            } catch (error) {
                log(`${name}: ${error.message}`, 'fail');
                results.failed++;
                results.tests.push({ name, status: 'fail', error: error.message });
            }
        }
        
        function runTests() {
            // æ¸…ç©ºç»“æœ
            document.getElementById('test-results').innerHTML = '<h2>ğŸ“‹ æµ‹è¯•ç»“æœ</h2>';
            results.passed = 0;
            results.failed = 0;
            results.warnings = 0;
            results.tests = [];
            
            log('å¼€å§‹æµ‹è¯•...', 'info');
            
            // æµ‹è¯•1ï¼šæ¨¡å—åŠ è½½
            test('StorageManagerå·²åŠ è½½', () => {
                return typeof window.StorageManager !== 'undefined';
            });
            
            test('StateManagerå·²åŠ è½½', () => {
                return typeof window.StateManager !== 'undefined';
            });
            
            test('getStateManagerå‡½æ•°å­˜åœ¨', () => {
                return typeof window.getStateManager === 'function';
            });
            
            test('initStateManagerå‡½æ•°å­˜åœ¨', () => {
                return typeof window.initStateManager === 'function';
            });
            
            test('TaskManagerå·²åŠ è½½', () => {
                return typeof window.TaskManager !== 'undefined';
            });
            
            test('getTaskManagerå‡½æ•°å­˜åœ¨', () => {
                return typeof window.getTaskManager === 'function';
            });
            
            // æµ‹è¯•2ï¼šStorageManager API
            test('StorageManager.saveStateå­˜åœ¨', () => {
                return typeof window.StorageManager?.saveState === 'function';
            });
            
            test('StorageManager.loadStateå­˜åœ¨', () => {
                return typeof window.StorageManager?.loadState === 'function';
            });
            
            test('StorageManager.exportDataå­˜åœ¨', () => {
                return typeof window.StorageManager?.exportData === 'function';
            });
            
            test('StorageManager.importDataå­˜åœ¨', () => {
                return typeof window.StorageManager?.importData === 'function';
            });
            
            test('StorageManager.clearDataå­˜åœ¨', () => {
                return typeof window.StorageManager?.clearData === 'function';
            });
            
            test('StorageManager.CURRENT_VERSIONå­˜åœ¨', () => {
                return typeof window.StorageManager?.CURRENT_VERSION !== 'undefined';
            });
            
            // æµ‹è¯•3ï¼šStateManagerå®ä¾‹åŒ–
            test('å¯ä»¥åˆ›å»ºStateManagerå®ä¾‹', () => {
                try {
                    const sm = new StateManager();
                    return sm !== null;
                } catch (e) {
                    return e.message;
                }
            });
            
            test('StateManageræœ‰getStateæ–¹æ³•', () => {
                const sm = new StateManager();
                return typeof sm.getState === 'function';
            });
            
            test('StateManageræœ‰setæ–¹æ³•', () => {
                const sm = new StateManager();
                return typeof sm.set === 'function';
            });
            
            test('StateManageræœ‰getæ–¹æ³•', () => {
                const sm = new StateManager();
                return typeof sm.get === 'function';
            });
            
            // æµ‹è¯•4ï¼šåŠŸèƒ½æµ‹è¯•
            test('StateManagerå¯ä»¥get/setæ•°æ®', () => {
                const sm = new StateManager();
                sm.set('test.value', 123);
                const value = sm.get('test.value');
                return value === 123 ? true : `æœŸæœ›123ï¼Œå¾—åˆ°${value}`;
            });
            
            test('StateManager.getStateè¿”å›æ·±æ‹·è´', () => {
                const sm = new StateManager();
                const state1 = sm.getState();
                state1.modified = true;
                const state2 = sm.getState();
                return !state2.modified; // åº”è¯¥æ˜¯æœªä¿®æ”¹çš„
            });
            
            // æµ‹è¯•4.5ï¼šTaskManageråŠŸèƒ½
            test('å¯ä»¥åˆ›å»ºTaskManagerå®ä¾‹', () => {
                try {
                    const sm = new StateManager();
                    const tm = new TaskManager(sm);
                    return tm !== null;
                } catch (e) {
                    return e.message;
                }
            });
            
            test('TaskManageræœ‰getDailyTasksæ–¹æ³•', () => {
                const sm = new StateManager();
                const tm = new TaskManager(sm);
                return typeof tm.getDailyTasks === 'function';
            });
            
            test('TaskManageræœ‰addDailyTaskæ–¹æ³•', () => {
                const sm = new StateManager();
                const tm = new TaskManager(sm);
                return typeof tm.addDailyTask === 'function';
            });
            
            test('TaskManagerå¯ä»¥æ·»åŠ å’Œè·å–ä»»åŠ¡', () => {
                try {
                    const sm = new StateManager();
                    const tm = new TaskManager(sm);
                    
                    tm.addDailyTask({ name: 'Test Task', dailyTime: 1 });
                    const tasks = tm.getDailyTasks();
                    
                    return tasks.length > 0 && tasks[0].name === 'Test Task';
                } catch (e) {
                    return e.message;
                }
            });
            
            // æµ‹è¯•5ï¼šlocalStorageç›¸å…³
            test('å¯ä»¥è¯»å–localStorage', () => {
                try {
                    const test = localStorage.getItem('matchstickTimeManager');
                    return true;
                } catch (e) {
                    return e.message;
                }
            });
            
            test('StorageManager.loadStateå¯ä»¥è°ƒç”¨', () => {
                try {
                    const result = StorageManager.loadState();
                    return true; // nullä¹Ÿæ˜¯æ­£å¸¸çš„
                } catch (e) {
                    return e.message;
                }
            });
            
            // æµ‹è¯•6ï¼šæ•°æ®ç‰ˆæœ¬
            const savedData = localStorage.getItem('matchstickTimeManager');
            if (savedData) {
                test('localStorageæ•°æ®å¯ä»¥è§£æ', () => {
                    try {
                        JSON.parse(savedData);
                        return true;
                    } catch (e) {
                        return e.message;
                    }
                });
                
                test('æ•°æ®åŒ…å«versionå­—æ®µ', () => {
                    try {
                        const data = JSON.parse(savedData);
                        return 'version' in data || 'warning';
                    } catch (e) {
                        return e.message;
                    }
                });
            }
            
            // æ˜¾ç¤ºæ€»ç»“
            showSummary();
        }
        
        function showSummary() {
            const summaryDiv = document.getElementById('summary');
            summaryDiv.style.display = 'block';
            
            const total = results.passed + results.failed + results.warnings;
            let status = 'âœ… å…¨éƒ¨é€šè¿‡';
            let color = '#28a745';
            
            if (results.failed > 0) {
                status = 'âŒ æœ‰å¤±è´¥';
                color = '#dc3545';
            } else if (results.warnings > 0) {
                status = 'âš ï¸ æœ‰è­¦å‘Š';
                color = '#ffc107';
            }
            
            summaryDiv.innerHTML = `
                <h2 style="color:${color}">${status}</h2>
                <p>æ€»æµ‹è¯•æ•°: ${total}</p>
                <p style="color:#28a745">âœ… é€šè¿‡: ${results.passed}</p>
                <p style="color:#dc3545">âŒ å¤±è´¥: ${results.failed}</p>
                <p style="color:#ffc107">âš ï¸ è­¦å‘Š: ${results.warnings}</p>
                
                ${results.failed === 0 ? `
                    <hr style="border-color:#4ec9b0; margin:20px 0">
                    <h3 style="color:#4ec9b0">ğŸ‰ é‡æ„æˆåŠŸï¼</h3>
                    <p>ä¸‹ä¸€æ­¥:</p>
                    <ol style="line-height:1.8">
                        <li>æ‰“å¼€ä¸»åº”ç”¨æµ‹è¯•åŠŸèƒ½</li>
                        <li>åˆ›å»ºæ•°æ®å¤‡ä»½</li>
                        <li>æäº¤ä»£ç : <code>git commit -am "Refactoring Phase 0 complete"</code></li>
                        <li>é˜…è¯» <code>é‡æ„å®Œæˆ-ä¸‹ä¸€æ­¥.md</code></li>
                    </ol>
                ` : `
                    <hr style="border-color:#dc3545; margin:20px 0">
                    <h3 style="color:#dc3545">âš ï¸ éœ€è¦ä¿®å¤</h3>
                    <p>è¯·æ£€æŸ¥å¤±è´¥çš„æµ‹è¯•é¡¹</p>
                `}
                
                <hr style="border-color:#4ec9b0; margin:20px 0">
                <h3>ğŸ“Š LocalStorageä¿¡æ¯</h3>
                <pre>${getStorageInfo()}</pre>
            `;
        }
        
        function getStorageInfo() {
            try {
                const data = localStorage.getItem('matchstickTimeManager');
                if (!data) {
                    return 'æš‚æ— æ•°æ®ï¼ˆæ–°ç”¨æˆ·ï¼‰';
                }
                
                const parsed = JSON.parse(data);
                return JSON.stringify({
                    version: parsed.version || 'æœªè®¾ç½®',
                    character: parsed.character?.name || 'æœªåˆ›å»º',
                    dataSize: (data.length / 1024).toFixed(2) + ' KB',
                    lastSaved: parsed.lastSaved || 'æœªçŸ¥',
                    flame: parsed.stats?.flame || 0,
                    totalDays: parsed.stats?.totalDays || 0
                }, null, 2);
            } catch (e) {
                return 'æ— æ³•è¯»å–: ' + e.message;
            }
        }
        
        function createBackup() {
            try {
                const data = localStorage.getItem('matchstickTimeManager');
                if (!data) {
                    alert('æ²¡æœ‰æ•°æ®éœ€è¦å¤‡ä»½');
                    return;
                }
                
                const backupKey = 'matchstickTimeManager_backup_' + new Date().toISOString().slice(0, 19).replace(/[T:]/g, '-');
                localStorage.setItem(backupKey, data);
                
                const backups = Object.keys(localStorage).filter(k => k.includes('backup'));
                alert(`âœ… å¤‡ä»½å·²åˆ›å»º: ${backupKey}\n\nå½“å‰æœ‰ ${backups.length} ä¸ªå¤‡ä»½`);
                
                console.log('å¤‡ä»½åˆ—è¡¨:');
                backups.forEach(k => console.log('  -', k));
            } catch (e) {
                alert('âŒ å¤‡ä»½å¤±è´¥: ' + e.message);
            }
        }
        
        function clearConsole() {
            console.clear();
            console.log('Console cleared');
        }
        
        // è‡ªåŠ¨è¿è¡Œæµ‹è¯•
        window.addEventListener('load', () => {
            setTimeout(runTests, 500);
        });
    </script>
</body>
</html>


<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>TaskManager功能测试</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        .test { margin: 10px 0; padding: 10px; border-radius: 4px; }
        .pass { background: #1e7e34; }
        .fail { background: #c82333; }
        h1 { color: #4ec9b0; }
        pre { background: #2d2d30; padding: 10px; border-radius: 4px; }
        button { 
            padding: 10px 20px; 
            margin: 10px 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            background: #007bff;
            color: white;
        }
    </style>
</head>
<body>
    <h1>🧪 TaskManager 功能测试</h1>
    <p>测试迁移的5个函数是否正常工作...</p>
    
    <button onclick="runTests()">▶️ 运行测试</button>
    <button onclick="location.reload()">🔄 重新加载</button>
    
    <div id="results"></div>
    
    <script src="scripts/core/storage.js"></script>
    <script src="scripts/core/state-manager.js"></script>
    <script src="scripts/core/task-manager.js"></script>
    
    <script>
        let testResults = [];
        
        function log(message, pass) {
            const div = document.createElement('div');
            div.className = `test ${pass ? 'pass' : 'fail'}`;
            div.textContent = `${pass ? '✅' : '❌'} ${message}`;
            document.getElementById('results').appendChild(div);
            testResults.push({ message, pass });
        }
        
        function runTests() {
            document.getElementById('results').innerHTML = '<h2>测试结果</h2>';
            testResults = [];
            
            try {
                // 测试1: 模块加载
                log('TaskManager类存在', typeof TaskManager !== 'undefined');
                log('getTaskManager函数存在', typeof getTaskManager === 'function');
                log('StateManager类存在', typeof StateManager !== 'undefined');
                log('StorageManager对象存在', typeof StorageManager !== 'undefined');
                
                // 测试2: 创建实例
                const sm = new StateManager();
                log('StateManager实例创建成功', sm !== null);
                
                const tm = new TaskManager(sm);
                log('TaskManager实例创建成功', tm !== null);
                
                // 测试3: 添加日常任务
                const dailyTask = tm.addDailyTask({
                    name: '测试任务',
                    dailyTime: 1,
                    importance: 3,
                    interest: 3
                });
                log('addDailyTask成功', dailyTask && dailyTask.name === '测试任务');
                
                // 测试4: 获取任务
                const tasks = tm.getDailyTasks();
                log('getDailyTasks成功', tasks.length > 0);
                log('任务有正确的ID', tasks[0].id !== undefined);
                log('任务有正确的名称', tasks[0].name === '测试任务');
                
                // 测试5: 更新任务
                const updated = tm.updateDailyTask(tasks[0].id, { name: '更新后的任务' });
                log('updateDailyTask成功', updated && updated.name === '更新后的任务');
                
                // 测试6: 删除任务
                const deleted = tm.deleteDailyTask(tasks[0].id);
                log('deleteDailyTask成功', deleted === true);
                log('任务已删除', tm.getDailyTasks().length === 0);
                
                // 测试7: 添加项目
                const project = tm.addProject({
                    name: '测试项目',
                    deadline: '2025-12-31',
                    dailyTime: 2,
                    importance: 4,
                    interest: 4,
                    milestones: [
                        { name: '里程碑1', date: '2025-11-01' }
                    ]
                });
                log('addProject成功', project && project.name === '测试项目');
                
                // 测试8: 删除项目
                const projectDeleted = tm.deleteProject(project.id);
                log('deleteProject成功', projectDeleted === true);
                
                // 测试9: 添加待办
                const todo = tm.addTodo({
                    name: '测试待办',
                    deadline: '2025-12-31',
                    estimatedTime: 1,
                    importance: 3,
                    urgency: 3
                });
                log('addTodo成功', todo && todo.name === '测试待办');
                
                // 测试10: 统计功能
                const count = tm.getPendingTasksCount();
                log('getPendingTasksCount成功', count.todo === 1);
                
                // 清理
                tm.deleteTodo(todo.id);
                
                // 总结
                const passed = testResults.filter(r => r.pass).length;
                const total = testResults.length;
                const percentage = Math.round((passed / total) * 100);
                
                const summary = document.createElement('div');
                summary.style.cssText = 'margin-top:20px;padding:15px;background:#2d2d30;border-radius:8px;';
                summary.innerHTML = `
                    <h2 style="color:${percentage === 100 ? '#28a745' : '#ffc107'}">
                        ${percentage === 100 ? '🎉 所有测试通过！' : '⚠️ 部分测试失败'}
                    </h2>
                    <p>通过: ${passed}/${total} (${percentage}%)</p>
                    ${percentage === 100 ? `
                        <p style="color:#4ec9b0">✅ TaskManager工作正常，可以继续迁移！</p>
                        <p>已测试的函数：</p>
                        <ul>
                            <li>addDailyTask()</li>
                            <li>updateDailyTask()</li>
                            <li>deleteDailyTask()</li>
                            <li>addProject()</li>
                            <li>deleteProject()</li>
                            <li>addTodo()</li>
                            <li>deleteTodo()</li>
                            <li>getPendingTasksCount()</li>
                        </ul>
                    ` : `
                        <p style="color:#dc3545">❌ 请检查失败的测试</p>
                    `}
                `;
                document.getElementById('results').appendChild(summary);
                
            } catch (error) {
                log(`致命错误: ${error.message}`, false);
                console.error('Test error:', error);
            }
        }
        
        // 自动运行
        window.addEventListener('load', () => {
            setTimeout(runTests, 500);
        });
    </script>
</body>
</html>


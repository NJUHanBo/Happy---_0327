<!DOCTYPE html>
<html>
<head>
    <title>State调试工具</title>
    <style>
        body { 
            font-family: monospace; 
            padding: 20px; 
            background: #1e1e1e; 
            color: #d4d4d4; 
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        pre {
            background: #2d2d30;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
    </style>
</head>
<body>
    <h1>🔍 State调试工具</h1>
    
    <button onclick="checkState()">检查当前State</button>
    <button onclick="addTestTask()">添加测试任务</button>
    <button onclick="location.reload()">刷新页面</button>
    <button onclick="location.href='/'">返回主应用</button>
    
    <div id="output"></div>
    
    <script src="scripts/core/storage.js"></script>
    <script src="scripts/core/state-manager.js"></script>
    <script src="scripts/core/task-manager.js"></script>
    <script src="scripts/main.js"></script>
    
    <script>
        function log(msg, isError = false) {
            const div = document.getElementById('output');
            const p = document.createElement('div');
            p.innerHTML = `<span class="${isError ? 'error' : 'success'}">${msg}</span>`;
            div.appendChild(p);
        }
        
        function checkState() {
            document.getElementById('output').innerHTML = '<h2>State检查结果</h2>';
            
            try {
                log('✅ window.state 存在: ' + (!!window.state));
                
                if (window.state) {
                    const dailyCount = (window.state.dailyTasks || []).length;
                    const projectCount = (window.state.projects || []).length;
                    const todoCount = (window.state.todos || []).length;
                    
                    log(`✅ 日常任务数量: ${dailyCount}`);
                    log(`✅ 项目数量: ${projectCount}`);
                    log(`✅ 待办数量: ${todoCount}`);
                    
                    if (dailyCount > 0) {
                        log('<br>📋 日常任务列表:');
                        window.state.dailyTasks.forEach((task, i) => {
                            log(`  ${i + 1}. ${task.name} (ID: ${task.id})`);
                        });
                    }
                    
                    if (projectCount > 0) {
                        log('<br>📋 项目列表:');
                        window.state.projects.forEach((proj, i) => {
                            log(`  ${i + 1}. ${proj.name} (ID: ${proj.id})`);
                        });
                    }
                    
                    if (todoCount > 0) {
                        log('<br>📋 待办列表:');
                        window.state.todos.forEach((todo, i) => {
                            log(`  ${i + 1}. ${todo.name} (ID: ${todo.id})`);
                        });
                    }
                    
                    log('<br><pre>' + JSON.stringify(window.state, null, 2) + '</pre>');
                }
                
                const tm = getTaskManager();
                log('<br>✅ TaskManager 可用: ' + (!!tm));
                
                if (tm) {
                    const tmDaily = tm.getDailyTasks().length;
                    const tmProjects = tm.getProjects().length;
                    const tmTodos = tm.getTodos().length;
                    
                    log(`✅ TaskManager看到的日常任务: ${tmDaily}`);
                    log(`✅ TaskManager看到的项目: ${tmProjects}`);
                    log(`✅ TaskManager看到的待办: ${tmTodos}`);
                }
                
            } catch (e) {
                log('❌ 错误: ' + e.message, true);
                console.error(e);
            }
        }
        
        function addTestTask() {
            try {
                const tm = getTaskManager();
                if (!tm) {
                    log('❌ TaskManager不可用', true);
                    return;
                }
                
                const testTask = tm.addDailyTask({
                    name: '调试测试任务 ' + Date.now(),
                    dailyTime: 30,
                    importance: 3,
                    interest: 3
                });
                
                log('✅ 测试任务已添加: ' + testTask.name);
                
                // 保存
                if (typeof saveState === 'function') {
                    saveState();
                    log('✅ State已保存');
                }
                
                // 重新检查
                setTimeout(checkState, 100);
                
            } catch (e) {
                log('❌ 添加失败: ' + e.message, true);
                console.error(e);
            }
        }
        
        // 自动检查
        window.addEventListener('load', () => {
            setTimeout(checkState, 500);
        });
    </script>
</body>
</html>

